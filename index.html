<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yumm Healthy Bites - Order Now!</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- QRious for QR Code Generation -->
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your Firebase Configuration (PASTE YOURS HERE)
        const firebaseConfig = {
            apiKey: "AIzaSyC8SabTNDL2ow1c98hcM_7KpxpC3N4M7nk",
            authDomain: "yummhealthybites.firebaseapp.com",
            projectId: "yummhealthybites",
            storageBucket: "yummhealthybites.firebasestorage.app",
            messagingSenderId: "35103379148",
            appId: "1:35103379148:web:b4ac3e23f3ce21655cfc69",
            measurementId: "G-CJGZ4DK4NW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make db and other necessary Firestore functions globally accessible
        window.db = db;
        window.firebaseCollection = collection; // Make collection globally available
        window.firebaseGetDocs = getDocs;       // Make getDocs globally available
        window.firebaseAddDoc = addDoc;         // Make addDoc globally available
        window.productsFromFirestore = []; // Global array to store fetched products
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Placeholder for background image. Replace 'URL_TO_YOUR_BACKGROUND_IMAGE' with your image file path. */
            background-image: url('https://placehold.co/1920x1080/fcf8f3/d2691e?text=Your+Background+Image+Here');
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Makes background static when scrolling */
            background-color: #fcf8f3; /* Fallback color */
        }
        .container {
            max-width: 960px;
        }
        .section-title {
            color: #d2691e; /* Chocolate brown for titles */
            border-bottom: 2px solid #f2d7b4; /* Light peach border */
            padding-bottom: 0.5rem;
            margin-bottom: 2rem;
        }
        .product-card {
            background-color: #ffffff;
            border: 1px solid #f2d7b4;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .btn-primary {
            background-color: #d2691e; /* Chocolate brown */
            color: #ffffff;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #a0522d; /* Darker brown */
        }
        .input-field {
            border: 1px solid #f2d7b4;
            background-color: #fffaf0; /* Ivory for input fields */
        }
        .order-summary {
            background-color: #fffaf0; /* Ivory background for summary */
            border: 1px solid #f2d7b4;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            position: relative; /* Added for absolute positioning of close button */
        }
        .modal-content.scale-100 {
            transform: scale(1);
            opacity: 1;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #a0522d;
            cursor: pointer;
            line-height: 1;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
        }
        .modal-close-btn:hover {
            background-color: #f2d7b4;
            color: #d2691e;
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="min-h-screen flex flex-col items-center py-12 px-4 sm:px-6 lg:px-8">
        <!-- Header Section -->
        <header class="text-center mb-12">
            <h1 class="text-5xl font-extrabold text-d2691e mb-4">Yumm Healthy Bites</h1>
            <p class="text-xl text-gray-600">Indulge your cravings without the guilt. Our baked goods are crafted with whole grains and jaggery.</p>
        </header>

        <!-- Menu Section -->
        <section id="menu" class="container w-full bg-white rounded-xl shadow-lg p-8 mb-12">
            <h2 class="text-3xl font-bold section-title text-center mb-8">Our Delicious Menu</h2>
            <div id="loading-menu" class="text-center text-gray-500 text-lg">Loading menu...</div>
            <div id="product-list" class="flex flex-col gap-10 hidden">
                <!-- Product categories and cards will be dynamically loaded here -->
            </div>
        </section>

        <!-- Order Form Section -->
        <section id="order-form-section" class="container w-full bg-white rounded-xl shadow-lg p-8 mb-12">
            <h2 class="text-3xl font-bold section-title text-center mb-8">Place Your Order</h2>
            <form id="order-form" class="space-y-6">
                <!-- Customer Details -->
                <div class="rounded-lg p-6 bg-fffaf0 border border-f2d7b4">
                    <h3 class="text-2xl font-semibold mb-4 text-d2691e">Your Details</h3>
                    <div>
                        <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="customerName" name="customerName" required
                               class="input-field w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-d2691e">
                    </div>
                    <div>
                        <label for="customerPhone" class="block text-sm font-medium text-gray-700 mb-1 mt-4">Phone Number</label>
                        <input type="tel" id="customerPhone" name="customerPhone" required
                               class="input-field w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-d2691e">
                    </div>
                    <div>
                        <label for="customerEmail" class="block text-sm font-medium text-gray-700 mb-1 mt-4">Email Address (Optional)</label>
                        <input type="email" id="customerEmail" name="customerEmail"
                               class="input-field w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-d2691e">
                    </div>
                    <div>
                        <label for="specialInstructions" class="block text-sm font-medium text-gray-700 mb-1 mt-4">Special Instructions (e.g., allergies, custom message)</label>
                        <textarea id="specialInstructions" name="specialInstructions" rows="3"
                                  class="input-field w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-d2691e"></textarea>
                    </div>
                </div>

                <!-- Order Summary & Total -->
                <div class="order-summary rounded-lg p-6">
                    <h3 class="text-2xl font-semibold mb-4 text-d2691e">Your Order Summary</h3>
                    <div id="order-summary-items" class="space-y-2 mb-4">
                        <!-- Order items will be displayed here -->
                        <p class="text-gray-500 text-center" id="empty-cart-message">Your cart is empty. Add items from the menu above!</p>
                    </div>
                    <div class="flex justify-between items-center text-xl font-bold border-t pt-4 border-f2d7b4">
                        <span>Total:</span>
                        <span id="order-total">â‚¹0.00</span>
                    </div>
                </div>

                <button type="submit" class="btn-primary w-full py-3 rounded-lg text-lg font-semibold shadow-md">Place Order</button>
            </form>
        </section>

        <!-- About Us / Contact Section -->
        <section id="contact" class="container w-full bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-3xl font-bold section-title text-center mb-8">Contact & About Us</h2>
            <div class="text-center space-y-4 text-gray-700">
                <p>We are a small business passionate about baking fresh, delicious treats for you!</p>
                <p>For custom orders or inquiries, please reach out to us:</p>
                <p class="font-semibold">Phone: +91 97675 19630</p>
                <p class="font-semibold">Email: ruchiraagrawal@yummhealthy.com</p>
                <p>Follow us on <a href="#" class="text-d2691e hover:underline font-semibold">Instagram</a> and <a href="#" class="text-d2691e hover:underline font-semibold">Facebook</a>!</p>
            </div>
        </section>

        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            &copy; 2025 Yumm Healthy Bites. All rights reserved.
        </footer>
    </div>

    <!-- Order Confirmation Modal -->
    <div id="order-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl max-w-lg w-full transform scale-95 opacity-0">
            <button class="modal-close-btn" id="top-close-modal-btn">&times;</button> <!-- New close button -->
            <h2 class="text-3xl font-bold text-d2691e mb-6 text-center">Order Confirmation</h2>
            <p class="text-gray-700 mb-4 text-center">Thank you for your order! Please use the options below to confirm your order and make payment.</p>

            <div class="mb-6 border-t border-b border-f2d7b4 py-4">
                <h3 class="text-xl font-semibold mb-3 text-center text-d2691e">Your Order Details Summary</h3>
                <textarea id="order-details-output" readonly rows="7" class="w-full p-4 border border-f2d7b4 rounded-lg bg-fffaf0 text-gray-800 text-sm mb-4"></textarea>
                <button id="copy-order-btn" class="btn-primary w-full py-2 rounded-lg text-md font-semibold shadow-md mb-2">Copy Order Summary</button>
            </div>

            <div class="text-center mb-6">
                <h3 class="text-xl font-semibold mb-3 text-d2691e">Pay with UPI</h3>
                <p class="text-gray-700 mb-4">Scan the QR code or click the button below to pay via your preferred UPI app.</p>
                <canvas id="upi-qr-code" class="w-48 h-48 mx-auto border border-f2d7b4 rounded-lg p-2"></canvas>
                <a id="upi-link-btn" href="#" class="btn-primary w-full py-3 rounded-lg text-lg font-semibold shadow-md mt-4 block text-center" target="_blank" rel="noopener noreferrer">Open UPI App to Pay</a>
            </div>

            <button id="close-modal-btn" class="w-full py-2 rounded-lg text-d2691e border border-d2691e hover:bg-d2691e hover:text-white transition-colors duration-200">Close</button>
        </div>
    </div>


    <script type="module">
        // Access Firebase functions globally after they are initialized in the first script block
        const db = window.db;
        const collection = window.firebaseCollection;
        const getDocs = window.firebaseGetDocs;
        const addDoc = window.firebaseAddDoc;

        let cart = {}; // Stores product ID and selected option ID and quantity: {'productId_optionId': quantity}
        let productsFromFirestore = []; // Will store products fetched from Firestore

        const productListDiv = document.getElementById('product-list');
        const loadingMenuDiv = document.getElementById('loading-menu');
        const orderSummaryItemsDiv = document.getElementById('order-summary-items');
        const orderTotalSpan = document.getElementById('order-total');
        const orderForm = document.getElementById('order-form');
        const orderModal = document.getElementById('order-modal');
        const orderDetailsOutput = document.getElementById('order-details-output');
        const copyOrderBtn = document.getElementById('copy-order-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const topCloseModalBtn = document.getElementById('top-close-modal-btn');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const upiQrCodeCanvas = document.getElementById('upi-qr-code');
        const upiLinkBtn = document.getElementById('upi-link-btn');

        // --- Configuration for UPI Payment ---
        // REPLACE WITH YOUR ACTUAL UPI VPA AND PAYEE NAME
        const YOUR_UPI_VPA = 'yourvpa@bank'; // Example: mobile number@upi or yourname@bank
        const YOUR_PAYEE_NAME = 'Yumm Healthy Bites'; // Your business name
        // --- End Configuration ---


        /**
         * Fetches products from Firestore and then renders them.
         */
        async function fetchAndRenderProducts() {
            loadingMenuDiv.classList.remove('hidden'); // Show loading message
            productListDiv.classList.add('hidden'); // Hide product list
            try {
                const productsCol = collection(db, 'products'); // Use the globally accessible 'collection'
                const productSnapshot = await getDocs(productsCol); // Use the globally accessible 'getDocs'
                productsFromFirestore = productSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Filter for available products only
                productsFromFirestore = productsFromFirestore.filter(product => product.isAvailable);

                renderProducts(); // Render the fetched products
                loadingMenuDiv.classList.add('hidden'); // Hide loading message
                productListDiv.classList.remove('hidden'); // Show product list
            } catch (error) {
                console.error("Error fetching products:", error);
                loadingMenuDiv.textContent = "Failed to load menu. Please try again later.";
            }
        }


        /**
         * Renders all product cards on the menu, categorized and with options.
         */
        function renderProducts() {
            productListDiv.innerHTML = ''; // Clear existing products
            const categories = ['Cakes', 'Cookies', 'Cupcakes', 'Others'];

            categories.forEach(category => {
                const categoryProducts = productsFromFirestore.filter(p => p.category === category);
                if (categoryProducts.length > 0) {
                    const categorySection = document.createElement('div');
                    categorySection.className = 'w-full mb-8'; // Full width, bottom margin
                    categorySection.innerHTML = `<h3 class="text-2xl font-bold text-d2691e mb-6 border-b-2 border-f2d7b4 pb-2">${category}</h3>`;
                    const productsGrid = document.createElement('div');
                    productsGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8';

                    categoryProducts.forEach(product => {
                        const productCard = document.createElement('div');
                        productCard.className = 'product-card rounded-lg p-6 flex flex-col items-center text-center';

                        let optionsHtml = '';
                        let initialQuantity = 0;
                        let selectedOptionIdForDisplay = product.options[0].optionId; // Default to the first option for display

                        // Find if this product (with any of its options) is in the cart
                        const cartEntryKeysForProduct = Object.keys(cart).filter(key => key.startsWith(`${product.id}_`));

                        if (cartEntryKeysForProduct.length > 0) {
                            // If yes, use the quantity and option from the first matching cart entry for initial display
                            const firstCartKey = cartEntryKeysForProduct[0];
                            const [, optionIdInCart] = firstCartKey.split('_');
                            selectedOptionIdForDisplay = optionIdInCart;
                            initialQuantity = cart[firstCartKey];
                        }

                        if (product.options.length > 1) {
                            optionsHtml = `<select class="product-option-select input-field w-full px-3 py-1 rounded-lg mb-3" data-product-id="${product.id}">`;
                            product.options.forEach(option => {
                                const isSelected = (option.optionId === selectedOptionIdForDisplay) ? 'selected' : '';
                                optionsHtml += `<option value="${option.optionId}" data-price="${option.price}" ${isSelected}>
                                                    ${option.label} - â‚¹${option.price.toFixed(2)}
                                                </option>`;
                            });
                            optionsHtml += `</select>`;
                        } else {
                            // If only one option, display its price directly
                            optionsHtml = `<p class="text-2xl font-bold text-gray-800 mb-4">â‚¹${product.options[0].price.toFixed(2)}</p>`;
                        }

                        productCard.innerHTML = `
                            <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-40 object-cover rounded-md mb-4" onerror="this.onerror=null;this.src='https://placehold.co/400x300/f2d7b4/d2691e?text=Image+Error';">
                            <h3 class="text-xl font-semibold mb-2 text-d2691e">${product.name}</h3>
                            <p class="text-gray-600 mb-3">${product.description}</p>
                            ${optionsHtml}
                            <div class="flex items-center space-x-2 mt-auto">
                                <button class="quantity-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300 transition-colors" data-product-id="${product.id}" data-action="decrease">-</button>
                                <input type="number" class="quantity-input w-16 text-center input-field rounded-lg" value="${initialQuantity}" min="0" data-product-id="${product.id}">
                                <button class="quantity-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300 transition-colors" data-product-id="${product.id}" data-action="increase">+</button>
                            </div>
                        `;
                        productsGrid.appendChild(productCard);
                    });
                    categorySection.appendChild(productsGrid);
                    productListDiv.appendChild(categorySection);
                }
            });

            addQuantityEventListeners();
            addOptionChangeListeners();
        }

        /**
         * Attaches event listeners to quantity buttons and input fields.
         */
        function addQuantityEventListeners() {
            document.querySelectorAll('.quantity-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productId = event.target.dataset.productId;
                    const action = event.target.dataset.action;
                    const quantityInput = document.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                    let quantity = parseInt(quantityInput.value);

                    if (action === 'increase') {
                        quantity++;
                    } else if (action === 'decrease' && quantity > 0) {
                        quantity--;
                    }
                    quantityInput.value = quantity;
                    
                    // Determine the currently selected option ID for this product
                    const selectedOptionElement = document.querySelector(`.product-option-select[data-product-id="${productId}"]`);
                    let optionId;
                    if (selectedOptionElement) {
                        optionId = selectedOptionElement.value;
                    } else {
                        // For products with only one option, get the default optionId
                        optionId = productsFromFirestore.find(p => p.id === productId).options[0].optionId;
                    }
                    updateCart(productId, optionId, quantity);
                });
            });

            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', (event) => {
                    const productId = event.target.dataset.productId;
                    let quantity = parseInt(event.target.value);
                    if (isNaN(quantity) || quantity < 0) {
                        quantity = 0;
                        event.target.value = 0;
                    }
                    
                    // Determine the currently selected option ID for this product
                    const selectedOptionElement = document.querySelector(`.product-option-select[data-product-id="${productId}"]`);
                    let optionId;
                    if (selectedOptionElement) {
                        optionId = selectedOptionElement.value;
                    } else {
                        // For products with only one option, get the default optionId
                        optionId = productsFromFirestore.find(p => p.id === productId).options[0].optionId;
                    }
                    updateCart(productId, optionId, quantity);
                });
            });
        }

        /**
         * Attaches event listeners to product option select dropdowns.
         */
        function addOptionChangeListeners() {
            document.querySelectorAll('.product-option-select').forEach(select => {
                select.addEventListener('change', (event) => {
                    const productId = event.target.dataset.productId;
                    const newOptionId = event.target.value;
                    const quantityInput = document.querySelector(`.quantity-input[data-product-id="${productId}"]`);

                    // Find the product to get its options
                    const product = productsFromFirestore.find(p => p.id === productId);
                    if (product) {
                        // Clear out quantities for all *other* options of this specific product in the cart
                        product.options.forEach(option => {
                            const key = `${productId}_${option.optionId}`;
                            if (cart[key] && option.optionId !== newOptionId) {
                                delete cart[key];
                            }
                        });
                    }

                    // Update the cart with the new option and current quantity from input
                    const currentQuantity = parseInt(quantityInput.value);
                    updateCart(productId, newOptionId, currentQuantity);
                });
            });
        }


        /**
         * Updates the cart based on product ID, selected option ID, and quantity.
         * @param {string} productId - The ID of the product.
         * @param {string} optionId - The ID of the selected option (e.g., '250g', '1pc').
         * @param {number} quantity - The new quantity of the product for the given option.
         */
        function updateCart(productId, optionId, quantity) {
            const key = `${productId}_${optionId}`;
            if (quantity > 0) {
                cart[key] = quantity;
            } else {
                delete cart[key];
            }
            renderOrderSummary();
        }

        /**
         * Gets the price for a specific product option.
         * @param {string} productId - The ID of the product.
         * @param {string} optionId - The ID of the selected option.
         * @returns {number} The price of the product option.
         */
        function getPrice(productId, optionId) {
            const product = productsFromFirestore.find(p => p.id === productId);
            if (product) {
                const option = product.options.find(o => o.optionId === optionId);
                if (option) {
                    return option.price;
                }
            }
            return 0; // Should not happen if product and option exist
        }

        /**
         * Renders the order summary section and calculates the total.
         */
        function renderOrderSummary() {
            orderSummaryItemsDiv.innerHTML = ''; // Clear existing items
            let total = 0;
            let hasItemsInCart = false;

            for (const key in cart) {
                const [productId, optionId] = key.split('_');
                const product = productsFromFirestore.find(p => p.id === productId);

                if (product) {
                    hasItemsInCart = true;
                    const quantity = cart[key];
                    const option = product.options.find(o => o.optionId === optionId);

                    if (option) {
                        const itemTotal = option.price * quantity;
                        total += itemTotal;

                        const summaryItem = document.createElement('div');
                        summaryItem.className = 'flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0';
                        summaryItem.innerHTML = `
                            <span>${product.name} (${option.label}) x ${quantity}</span>
                            <span>â‚¹${itemTotal.toFixed(2)}</span>
                        `;
                        orderSummaryItemsDiv.appendChild(summaryItem);
                    }
                }
            }

            if (hasItemsInCart) {
                emptyCartMessage.classList.add('hidden');
            } else {
                emptyCartMessage.classList.remove('hidden');
            }

            orderTotalSpan.textContent = `â‚¹${total.toFixed(2)}`;
        }

        /**
         * Handles the order form submission and saves order to Firestore.
         */
        orderForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission

            if (Object.keys(cart).length === 0) {
                const messageBox = document.createElement('div');
                messageBox.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                messageBox.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                        <p class="text-lg mb-4">Your cart is empty! Please add some items to place an order.</p>
                        <button class="btn-primary px-6 py-2 rounded-lg" onclick="this.parentNode.parentNode.remove()">OK</button>
                    </div>
                `;
                document.body.appendChild(messageBox);
                return;
            }

            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const customerEmail = document.getElementById('customerEmail').value;
            const specialInstructions = document.getElementById('specialInstructions').value;

            let orderedItems = [];
            let total = 0;
            let orderDetailsText = `--- Yumm Healthy Bites Order ---\n\n`;
            orderDetailsText += `Customer Name: ${customerName}\n`;
            orderDetailsText += `Phone Number: ${customerPhone}\n`;
            if (customerEmail) {
                orderDetailsText += `Email: ${customerEmail}\n`;
            }
            if (specialInstructions) {
                orderDetailsText += `Special Instructions: ${specialInstructions}\n`;
            }
            orderDetailsText += `\n--- Order Items ---\n`;


            for (const key in cart) {
                const [productId, optionId] = key.split('_');
                const product = productsFromFirestore.find(p => p.id === productId);
                if (product) {
                    const quantity = cart[key];
                    const option = product.options.find(o => o.optionId === optionId);
                    if (option) {
                        const itemTotal = option.price * quantity;
                        total += itemTotal;
                        orderedItems.push({
                            productId: productId,
                            productName: product.name,
                            optionId: optionId,
                            optionLabel: option.label,
                            pricePerUnit: option.price,
                            quantity: quantity,
                            itemTotal: itemTotal
                        });
                        orderDetailsText += `${product.name} (${option.label}) (x${quantity}) - â‚¹${itemTotal.toFixed(2)}\n`;
                    }
                }
            }
            orderDetailsText += `\nTotal Amount: â‚¹${total.toFixed(2)}\n\n`;
            orderDetailsText += `Please copy this summary and send it to us via WhatsApp, email, or your preferred method.`;


            // Prepare order object for Firestore
            const newOrder = {
                customerName: customerName,
                customerPhone: customerPhone,
                customerEmail: customerEmail,
                specialInstructions: specialInstructions,
                items: orderedItems,
                totalAmount: total,
                orderDate: new Date(), // Timestamp
                status: 'New' // Initial status
            };

            try {
                // Add the order to Firestore
                const docRef = await addDoc(collection(db, "orders"), newOrder); // Use the globally accessible 'addDoc' and 'collection'
                console.log("Order written with ID: ", docRef.id);

                orderDetailsText += `\nYour Order ID: ${docRef.id}`; // Add order ID to summary for customer


                orderDetailsOutput.value = orderDetailsText;

                // Generate UPI Link and QR Code
                const transactionId = docRef.id; // Use Firestore document ID as transaction ID
                const transactionNote = encodeURIComponent(`Yumm Healthy Bites Order #${transactionId}`);
                const upiLink = `upi://pay?pa=${YOUR_UPI_VPA}&pn=${encodeURIComponent(YOUR_PAYEE_NAME)}&am=${total.toFixed(2)}&cu=INR&tn=${transactionNote}&tr=${transactionId}`;

                upiLinkBtn.href = upiLink; // Set the direct UPI link

                // Generate QR code using QRious
                new QRious({
                    element: upiQrCodeCanvas,
                    value: upiLink,
                    size: 200,
                    padding: 10,
                    background: '#fffaf0',
                    foreground: '#d2691e',
                });

                orderModal.classList.remove('hidden');
                setTimeout(() => {
                    orderModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                    orderModal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
                }, 50);

                // Reset the form and cart after order is placed
                orderForm.reset();
                cart = {};
                renderProducts(); // Re-render products to reset quantities to 0
                renderOrderSummary(); // Clear order summary

            } catch (e) {
                console.error("Error adding document: ", e);
                const messageBox = document.createElement('div');
                messageBox.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                messageBox.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                        <p class="text-lg mb-4 text-red-600">There was an error placing your order. Please try again or contact us directly.</p>
                        <p class="text-sm text-gray-500">${e.message}</p>
                        <button class="btn-primary px-6 py-2 rounded-lg mt-4" onclick="this.parentNode.parentNode.remove()">OK</button>
                    </div>
                `;
                document.body.appendChild(messageBox);
            }
        });

        /**
         * Copies the order details to the clipboard.
         */
        copyOrderBtn.addEventListener('click', () => {
            orderDetailsOutput.select();
            document.execCommand('copy');
            copyOrderBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyOrderBtn.textContent = 'Copy Order Summary';
            }, 2000);
        });

        /**
         * Closes the order confirmation modal.
         */
        function closeOrderModal() {
            orderModal.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100');
            orderModal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
            setTimeout(() => { // Hide modal after animation
                orderModal.classList.add('hidden');
            }, 300);
        }

        // Event listeners for closing the modal
        closeModalBtn.addEventListener('click', closeOrderModal);
        topCloseModalBtn.addEventListener('click', closeOrderModal);


        // Initialize the page on load
        window.onload = () => {
            fetchAndRenderProducts(); // Fetch from Firestore instead of direct render
            renderOrderSummary();
        };
    </script>
</body>
</html>
