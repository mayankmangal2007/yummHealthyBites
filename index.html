<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yumm Healthy Bites - Order Now!</title>

    <!-- Tailwind CSS CDN for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Font - Inter for a modern, clean typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase SDKs for connecting to Firestore -->
    <script type="module">
        // Import specific Firebase services/functions needed
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration: Replace with your actual project details from Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyC8SabTNDL2ow1c98hcM_7KpxpC3N4M7nk",
            authDomain: "yummhealthybites.firebaseapp.com",
            projectId: "yummhealthybites",
            storageBucket: "yummhealthybites.firebasestorage.app",
            messagingSenderId: "35103379148",
            appId: "1:35103379148:web:b4ac3e23f3ce21655cfc69",
            measurementId: "G-CJGZ4DK4NW"
        };

        // Initialize Firebase App
        const app = initializeApp(firebaseConfig);
        // Get Firestore instance
        const db = getFirestore(app);

        // Expose Firebase objects and functions globally as we are not using separate module files.
        // This makes them accessible to other parts of the script easily.
        window.db = db;
        window.firebaseCollection = collection;
        window.firebaseGetDocs = getDocs;
        window.firebaseAddDoc = addDoc;
    </script>

    <!-- Custom CSS for styling, building upon Tailwind -->
    <style>
        /* Base Styles & Typography */
        body {
            font-family: 'Inter', sans-serif;
            /* Placeholder for background image. Replace 'URL_TO_YOUR_BACKGROUND_IMAGE' with your image file path. */
            background-image: url('https://placehold.co/1920x1080/fcf8f3/d2691e?text=Your+Background+Image+Here');
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Makes background static when scrolling */
            background-color: #fcf8f3; /* Fallback color */
            overflow-x: hidden; /* Prevent horizontal scroll on small devices */
        }
        .container {
            max-width: 960px; /* Max width for content area */
            margin-left: auto;
            margin-right: auto;
            padding-left: 1rem; /* Responsive padding on left */
            padding-right: 1rem; /* Responsive padding on right */
        }
        /* Main section titles, inspired by Booksaw's bold headings */
        .section-title {
            color: #d2691e; /* Chocolate brown for titles */
            border-bottom: 2px solid #f2d7b4; /* Light peach border */
            padding-bottom: 0.5rem;
            margin-bottom: 2rem;
            font-weight: 800; /* Extra bold for emphasis */
            font-size: 3rem; /* Larger font for section titles */
        }
        @media (max-width: 768px) {
            .section-title {
                font-size: 2.5rem; /* Adjust for smaller screens */
            }
        }

        /* Product Card Styles */
        .product-card {
            background-color: #ffffff;
            border: 1px solid #f2d7b4;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08); /* More pronounced shadow */
            border-radius: 12px; /* Slightly more rounded */
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 1.5rem; /* Increased padding */
        }
        .product-card:hover {
            transform: translateY(-8px); /* More noticeable lift */
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.15); /* Stronger shadow on hover */
        }
        .product-card img {
            border-radius: 8px; /* Rounded images */
            margin-bottom: 1rem;
        }
        .product-card h3 {
            font-size: 1.5rem; /* Slightly larger product titles */
            font-weight: 700;
        }

        /* Button Styles (Primary action) */
        .btn-primary {
            background-color: #d2691e; /* Chocolate brown */
            color: #ffffff;
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            padding: 1rem 2rem; /* More prominent buttons */
            border-radius: 8px; /* Slightly rounded */
            font-weight: 700;
        }
        .btn-primary:hover {
            background-color: #a0522d; /* Darker brown */
            transform: translateY(-2px); /* Lift effect */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2); /* Stronger shadow */
        }

        /* Input Field Styles */
        .input-field {
            border: 1px solid #e0c8b3; /* Softer border color */
            background-color: #fffaf0; /* Ivory for input fields */
            padding: 0.85rem 1.25rem; /* Increased padding */
            border-radius: 0.625rem; /* More rounded corners */
            transition: border-color 0.2s, box-shadow 0.2s;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06); /* Subtle inner shadow */
        }
        .input-field:focus {
            outline: none;
            border-color: #d2691e;
            box-shadow: 0 0 0 4px rgba(210, 105, 30, 0.25); /* More visible focus ring */
        }

        /* Order Summary Box Styles */
        .order-summary {
            background-color: #fffaf0; /* Ivory background for summary */
            border: 1px solid #f2d7b4;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        /* Modal Styles (for Order Confirmation) */
        .modal {
            background-color: rgba(0, 0, 0, 0.75); /* Darker overlay */
        }
        .modal-content {
            background-color: #ffffff;
            border-radius: 16px; /* More rounded modal */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: scale(0.9); /* Start slightly smaller for better animation */
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.4s ease-out; /* Bouncier transition */
        }
        .modal-content.scale-100 {
            transform: scale(1);
            opacity: 1;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 2rem; /* Larger close button */
            color: #d2691e; /* Match theme color */
            cursor: pointer;
            line-height: 1;
            padding: 0.75rem; /* Larger hit area */
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s, transform 0.2s;
        }
        .modal-close-btn:hover {
            background-color: #f2d7b4;
            color: #a0522d;
            transform: rotate(90deg); /* Little animation */
        }

        /* Navigation Bar Styles */
        .nav-link {
            transition: color 0.2s, background-color 0.2s;
        }
        .nav-link:hover {
            color: #d2691e;
            background-color: #f2d7b4;
            border-radius: 0.5rem;
        }

        /* Category Button Styles (Menu Shortcuts) */
        .category-button {
            background-color: #f2d7b4; /* Light peach */
            color: #d2691e; /* Chocolate brown */
            padding: 0.8rem 1.8rem; /* More generous padding */
            border-radius: 9999px; /* Pill shape */
            font-weight: 700; /* Bolder font */
            font-size: 1.1rem; /* Slightly larger text */
            transition: background-color 0.3s, transform 0.3s, box-shadow 0.3s;
            display: inline-block;
        }
        .category-button:hover {
            background-color: #d2691e; /* Darker brown */
            color: #ffffff;
            transform: translateY(-3px); /* More lift */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Hero Section Specific Styles for Text Readability */
        #hero .relative {
            background-color: rgba(255, 255, 255, 0.1); /* Subtle transparent white background for text */
            backdrop-filter: blur(2px); /* Slight blur behind text */
            border-radius: 1rem;
            padding: 2rem;
        }
        #hero h1 {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
            font-size: 4.5rem; /* Large heading */
        }
        #hero p {
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            font-size: 2rem; /* Large paragraph */
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) { /* Medium screens */
            #hero h1 {
                font-size: 3rem;
            }
            #hero p {
                font-size: 1.5rem;
            }
            .nav-item {
                font-size: 0.875rem; /* Smaller nav links on small screens */
            }
            .category-button {
                padding: 0.6rem 1.2rem;
                font-size: 1rem;
            }
        }
        @media (max-width: 640px) { /* Small screens (Tailwind's sm breakpoint) */
            .product-card {
                padding: 1rem;
            }
            .product-card h3 {
                font-size: 1.25rem;
            }
            .product-card p {
                font-size: 0.875rem;
            }
        }

        /* Fade-in Animation for Product Cards (from bottom) */
        .fade-in-bottom {
            opacity: 0;
            transform: translateY(30px); /* Start from a bit below */
            transition: opacity 0.8s ease-out, transform 0.8s ease-out; /* Slower and smoother transition */
        }
        .fade-in-bottom.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Primary Application Container -->
    <div class="min-h-screen flex flex-col items-center pb-12 w-full">

        <!-- Header Section: Sticky Navigation Bar -->
        <nav class="sticky top-0 z-50 w-full bg-white shadow-lg py-4 px-8 rounded-b-xl">
            <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
                <a href="#hero" class="text-3xl font-extrabold text-d2691e mb-3 sm:mb-0">Yumm Healthy Bites</a>
                <div class="flex flex-wrap justify-center space-x-4 sm:space-x-6">
                    <a href="#hero" class="text-gray-700 font-semibold px-3 py-2 nav-link nav-item">Home</a>
                    <a href="#menu" class="text-gray-700 font-semibold px-3 py-2 nav-link nav-item">Menu</a>
                    <a href="#order-form-section" class="text-gray-700 font-semibold px-3 py-2 nav-link nav-item">Order Now</a>
                    <a href="#contact" class="text-gray-700 font-semibold px-3 py-2 nav-link nav-item">Contact</a>
                </div>
            </div>
        </nav>

        <!-- Main Content Area with consistent padding -->
        <div class="py-12 px-4 sm:px-6 lg:px-8 w-full">

            <!-- Hero Section: Welcoming Banner -->
            <section id="hero" class="w-full relative h-[500px] flex items-center justify-center text-center mb-16 rounded-xl overflow-hidden shadow-xl"
                style="background-image: url('https://placehold.co/1200x500/f2d7b4/d2691e?text=Delicious+Baked+Goods'); background-size: cover; background-position: center;">
                <div class="absolute inset-0 bg-black opacity-40"></div>
                <div class="relative z-10 text-white p-8 sm:p-12 rounded-lg max-w-3xl">
                    <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold mb-4 drop-shadow-lg leading-tight">Baked with Love, Crafted for Health</h1>
                    <p class="text-lg sm:text-xl lg:text-2xl font-light mb-8 drop-shadow-md">Indulge your cravings without the guilt. Our baked goods are crafted with whole grains and jaggery.</p>
                    <a href="#menu" class="btn-primary px-8 py-3 rounded-full text-lg sm:text-xl font-bold shadow-lg hover:scale-105">Explore Our Menu</a>
                </div>
            </section>

            <!-- Menu Section: Displaying Products -->
            <section id="menu" class="container w-full bg-white rounded-xl shadow-lg p-8 mb-16">
                <h2 class="text-center mb-10 section-title">Our Delicious Menu</h2>

                <!-- Category Navigation Buttons (Shortcut links) -->
                <div class="flex flex-wrap justify-center gap-3 sm:gap-4 mb-12">
                    <a href="#cakes-section" class="category-button">Cakes</a>
                    <a href="#cookies-section" class="category-button">Cookies</a>
                    <a href="#cupcakes-section" class="category-button">Cupcakes</a>
                    <a href="#others-section" class="category-button">Others</a>
                </div>

                <!-- Loading message for menu -->
                <div id="loading-menu" class="text-center text-gray-500 text-xl py-10">Loading menu...</div>
                
                <!-- Product List container (hidden until loaded) -->
                <div id="product-list" class="flex flex-col gap-10 hidden">
                    <!-- Product categories and cards will be dynamically loaded here by JavaScript -->
                </div>
            </section>

            <!-- Order Form Section: Customer Details & Order Summary -->
            <section id="order-form-section" class="container w-full bg-white rounded-xl shadow-lg p-8 mb-16">
                <h2 class="text-center mb-10 section-title">Place Your Order</h2>
                <form id="order-form" class="space-y-6">
                    <!-- Customer Details Input Block -->
                    <div class="rounded-lg p-6 bg-fffaf0 border border-f2d7b4">
                        <h3 class="text-2xl font-semibold mb-4 text-d2691e">Your Details</h3>
                        <div>
                            <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                            <input type="text" id="customerName" name="customerName" required
                                class="input-field w-full">
                        </div>
                        <div>
                            <label for="customerPhone" class="block text-sm font-medium text-gray-700 mb-1 mt-4">Phone Number</label>
                            <input type="tel" id="customerPhone" name="customerPhone" required
                                class="input-field w-full">
                        </div>
                        <div>
                            <label for="customerEmail" class="block text-sm font-medium text-gray-700 mb-1 mt-4">Email Address (Optional)</label>
                            <input type="email" id="customerEmail" name="customerEmail"
                                class="input-field w-full">
                        </div>
                        <div>
                            <label for="specialInstructions" class="block text-sm font-medium text-gray-700 mb-1 mt-4">Special Instructions (e.g., allergies, custom message)</label>
                            <textarea id="specialInstructions" name="specialInstructions" rows="3"
                                    class="input-field w-full"></textarea>
                        </div>
                    </div>

                    <!-- Order Summary & Total Display -->
                    <div class="order-summary rounded-lg p-6">
                        <h3 class="text-2xl font-semibold mb-4 text-d2691e">Your Order Summary</h3>
                        <div id="order-summary-items" class="space-y-2 mb-4">
                            <!-- Order items will be displayed here by JavaScript -->
                            <p class="text-gray-500 text-center py-4" id="empty-cart-message">Your cart is empty. Add items from the menu above!</p>
                        </div>
                        <div class="flex justify-between items-center text-xl font-bold border-t pt-4 border-f2d7b4">
                            <span>Total:</span>
                            <span id="order-total">₹0.00</span>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary w-full py-3 rounded-lg text-lg font-semibold shadow-md">Place Order</button>
                </form>
            </section>

            <!-- About Us / Contact Section -->
            <section id="contact" class="container w-full bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-center mb-10 section-title">Contact & About Us</h2>
                <div class="text-center space-y-4 text-gray-700">
                    <p class="text-lg">We are a small business passionate about baking fresh, delicious treats for you!</p>
                    <p class="text-lg">For custom orders or inquiries, please reach out to us:</p>
                    <p class="font-semibold text-xl">Phone: +91 97675 19630</p>
                    <p class="font-semibold text-xl">Email: ruchiraagrawal@yummhealthy.com</p>
                    <p class="text-lg">Follow us on <a href="#" class="text-d2691e hover:underline font-semibold">Instagram</a> and <a href="#" class="text-d2691e hover:underline font-semibold">Facebook</a>!</p>
                </div>
            </section>

        </div> <!-- End of main content area -->

        <!-- Footer Section -->
        <footer class="mt-12 text-center text-gray-500 text-sm py-6">
            &copy; 2025 Yumm Healthy Bites. All rights reserved.
        </footer>
    </div> <!-- End of Primary Application Container -->

    <!-- Order Confirmation Modal -->
    <div id="order-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl max-w-lg w-full transform scale-95 opacity-0">
            <!-- Close button for the modal -->
            <button class="modal-close-btn" id="top-close-modal-btn">&times;</button>
            <h2 class="text-3xl font-bold text-d2691e mb-6 text-center">Order Confirmation</h2>
            <p class="text-gray-700 mb-4 text-center">Your order has been placed successfully! Payment will be collected during delivery.</p>

            <!-- Order Details Summary area -->
            <div class="mb-6 border-t border-b border-f2d7b4 py-4">
                <h3 class="text-xl font-semibold mb-3 text-center text-d2691e">Your Order Details Summary</h3>
                <textarea id="order-details-output" readonly rows="7" class="w-full p-4 border border-f2d7b4 rounded-lg bg-fffaf0 text-gray-800 text-sm mb-4"></textarea>
                <button id="copy-order-btn" class="btn-primary w-full py-2 rounded-lg text-md font-semibold shadow-md mb-2">Copy Order Summary</button>
            </div>
            
            <!-- WhatsApp Order Link -->
            <a id="whatsapp-order-btn" href="#" target="_blank" rel="noopener noreferrer" class="btn-primary w-full py-3 rounded-lg text-lg font-semibold shadow-md mt-4 flex items-center justify-center space-x-2">
                <svg viewBox="0 0 24 24" width="24" height="24" class="inline-block text-white">
                    <path fill="currentColor" d="M12.04 2C7.35 2 3.57 5.79 3.57 10.48c0 1.95.63 3.82 1.7 5.37L2 22l6.23-1.65c1.47.8 3.16 1.25 4.61 1.25H12c4.69 0 8.47-3.79 8.47-8.48S16.73 2 12.04 2zM17.15 15.6c-.2-.1-.8-.4-.95-.45s-.27-.08-.4-.05c-.13.04-.5.5-.63.6s-.26.12-.45.05c-.2-.07-.82-.3-1.07-.6-.25-.3-.42-.5-.14-.77s.19-.24.3-.4c.1-.15.2-.25.3-.4s.13-.2.08-.3c-.04-.1-.13-.25-.18-.35s-.4-.95-.55-1.3c-.15-.35-.3-.29-.4-.29h-.3c-.1-.01-.25.04-.4.19s-.6.6-.6.72c0 .12.08.23.1.25.13.2.26.24.43.4.17.16.3.29.4.4.1.1.2.19.07.45-.1.2-.67.92-.77 1.1-.1.17-.18.2-.3.2s-.2-.05-.4-.1c-.13-.04-.8-.3-1.08-.7c-.28-.4-.34-.4-.5-.4c-.16 0-.3.04-.4.1s-.27.2-.4.35-.18.3-.06.5c.1.2.5.9.5 1.05s-.2.2-.4.2c-.2.01-.8-.3-.95-.45s-.27-.08-.4-.05c-.13.04-.5.5-.63.6s-.26.12-.45.05c-.2-.07-.82-.3-1.07-.6-.25-.3-.42-.5-.14-.77s.19-.24.3-.4c.1-.15.2-.25.3-.4s.13-.2.08-.3c-.04-.1-.13-.25-.18-.35s-.4-.95-.55-1.3c-.15-.35-.3-.29-.4-.29h-.3c-.1-.01-.25.04-.4.19s-.6.6-.6.72c0 .12.08.23.1.25.13.2.26.24.43.4.17.16.3.29.4.4.1.1.2.19.07.45-.1.2-.67.92-.77 1.1-.1.17-.18.2-.3.2s-.2-.05-.4-.1c-.13-.04-.8-.3-1.08-.7c-.28-.4-.34-.4-.5-.4c-.16 0-.3.04-.4.1s-.27.2-.4.35-.18.3-.06.5c.1.2.5.9.5 1.05s-.2.2-.4.2c-.2.01-.8-.3-.95-.45s-.27-.08-.4-.05c-.13.04-.5.5-.63.6s-.26.12-.45.05c-.2-.07-.82-.3-1.07-.6-.25-.3-.42-.5-.14-.77s.19-.24.3-.4c.1-.15.2-.25.3-.4s.13-.2.08-.3c-.04-.1-.13-.25-.18-.35s-.4-.95-.55-1.3c-.15-.35-.3-.29-.4-.29h-.3c-.1-.01-.25.04-.4.19s-.6.6-.6.72c0 .12.08.23.1.25.13.2.26.24.43.4.17.16.3.29.4.4.1.1.2.19.07.45-.1.2-.67.92-.77 1.1-.1.17-.18.2-.3.2s-.2-.05-.4-.1c-.13-.04-.8-.3-1.08-.7c-.28-.4-.34-.4-.5-.4c-.16 0-.3.04-.4.1s-.27.2-.4.35-.18.3-.06.5c.1.2.5.9.5 1.05s-.2.2-.4.2z"/>
                </svg>
                <span>Send Order via WhatsApp</span>
            </a>

            <!-- Bottom close button for the modal -->
            <button id="close-modal-btn" class="w-full py-2 rounded-lg text-d2691e border border-d2691e hover:bg-d2691e hover:text-white transition-colors duration-200 mt-4">Close</button>
        </div>
    </div>


    <!-- Main Application Logic (all consolidated into one script block) -->
    <script type="module">
        // --- Firebase Globals (from the first script block) ---
        // These are made available globally by the preceding <script type="module"> tag.
        const db = window.db;
        const collection = window.firebaseCollection;
        const getDocs = window.firebaseGetDocs;
        const addDoc = window.firebaseAddDoc;

        // --- Global State Variables ---
        let cart = {}; // Stores product ID and selected option ID and quantity: {'productId_optionId': quantity}
        let productsFromFirestore = []; // Will store product data fetched from Firestore

        // --- Configuration Constants ---
        const WHATSAPP_PHONE_NUMBER = '919999999999'; // WhatsApp number (with country code, no + or spaces)
        const CATEGORIES = ['Cakes', 'Cookies', 'Cupcakes', 'Others'];
        const SCROLL_OFFSET = 20; // Additional padding below the sticky header for smooth scroll

        // --- DOM Element References ---
        const productListDiv = document.getElementById('product-list');
        const loadingMenuDiv = document.getElementById('loading-menu');
        const orderSummaryItemsDiv = document.getElementById('order-summary-items');
        const orderTotalSpan = document.getElementById('order-total');
        const orderForm = document.getElementById('order-form');
        const orderModal = document.getElementById('order-modal');
        const orderDetailsOutput = document.getElementById('order-details-output');
        const copyOrderBtn = document.getElementById('copy-order-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const topCloseModalBtn = document.getElementById('top-close-modal-btn');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const navBar = document.querySelector('nav'); // Reference to the sticky nav bar
        const whatsappOrderBtn = document.getElementById('whatsapp-order-btn');


        // --- Core Functions ---

        /**
         * Fetches available products from Firestore and then initiates rendering them on the menu.
         */
        async function fetchAndRenderProducts() {
            loadingMenuDiv.classList.remove('hidden'); // Show loading message
            productListDiv.classList.add('hidden');    // Hide product list
            try {
                const productsCol = collection(db, 'products'); // Get a reference to the 'products' collection
                const productSnapshot = await getDocs(productsCol); // Fetch all documents in the collection
                
                // Map document data to our productsFromFirestore array, including their IDs
                productsFromFirestore = productSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Filter for products that are marked as 'isAvailable: true' in Firestore
                productsFromFirestore = productsFromFirestore.filter(product => product.isAvailable);

                renderProducts(); // Call renderProducts to display the fetched items
                loadingMenuDiv.classList.add('hidden'); // Hide loading message
                productListDiv.classList.remove('hidden'); // Show product list
            } catch (error) {
                console.error("Error fetching products:", error);
                loadingMenuDiv.textContent = "Failed to load menu. Please try again later. Error: " + error.message;
            }
        }


        /**
         * Renders all product cards on the menu, categorized and with quantity controls.
         * Products are grouped by category (Cakes, Cookies, Cupcakes, Others).
         */
        function renderProducts() {
            productListDiv.innerHTML = ''; // Clear any existing products rendered on the page

            // Loop through each defined category
            CATEGORIES.forEach(category => {
                // Filter products that belong to the current category
                const categoryProducts = productsFromFirestore.filter(p => p.category === category);
                
                // Only render the category section if there are products in it
                if (categoryProducts.length > 0) {
                    // Create a unique ID for the category section to allow smooth scrolling to it
                    const categoryId = category.toLowerCase().replace(/\s/g, '-') + '-section';
                    
                    const categorySection = document.createElement('div');
                    categorySection.className = 'w-full mb-8'; // Full width, with bottom margin
                    // Add an ID to the h3 for direct navigation and padding/negative margin for scroll offset (due to sticky header)
                    categorySection.innerHTML = `<h3 id="${categoryId}" class="text-3xl font-bold text-d2691e mb-6 border-b-2 border-f2d7b4 pb-2 pt-16 -mt-16">${category}</h3>`;
                    
                    const productsGrid = document.createElement('div');
                    // Grid layout for product cards with responsive columns and side padding
                    productsGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 px-6 sm:px-0';

                    // Loop through products in the current category and create their cards
                    categoryProducts.forEach(product => {
                        const productCard = document.createElement('div');
                        // Add 'fade-in-bottom' class for animation effect
                        productCard.className = 'product-card rounded-lg p-6 flex flex-col items-center text-center fade-in-bottom';

                        let optionsHtml = '';
                        let initialQuantity = 0;
                        // Default to the first option's ID for display purposes
                        let selectedOptionIdForDisplay = product.options[0].optionId; 

                        // Check if any option for this product is already in the cart
                        const cartEntryKeysForProduct = Object.keys(cart).filter(key => key.startsWith(`${product.id}_`));

                        if (cartEntryKeysForProduct.length > 0) {
                            // If found in cart, set initial quantity and selected option based on the cart data
                            const firstCartKey = cartEntryKeysForProduct[0];
                            const [, optionIdInCart] = firstCartKey.split('_');
                            selectedOptionIdForDisplay = optionIdInCart;
                            initialQuantity = cart[firstCartKey];
                        }

                        // Generate HTML for product options (dropdown if multiple, or just price if one)
                        if (product.options.length > 1) {
                            optionsHtml = `<select class="product-option-select input-field w-full px-3 py-1 rounded-lg mb-3" data-product-id="${product.id}">`;
                            product.options.forEach(option => {
                                const isSelected = (option.optionId === selectedOptionIdForDisplay) ? 'selected' : '';
                                optionsHtml += `<option value="${option.optionId}" data-price="${option.price}" ${isSelected}>
                                                    ${option.label} - ₹${option.price.toFixed(2)}
                                                </option>`;
                            });
                            optionsHtml += `</select>`;
                        } else {
                            // If only one option, display its price directly
                            optionsHtml = `<p class="text-2xl font-bold text-gray-800 mb-4">₹${product.options[0].price.toFixed(2)}</p>`;
                        }

                        // Construct the HTML for a single product card
                        productCard.innerHTML = `
                            <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-40 object-cover rounded-md mb-4" onerror="this.onerror=null;this.src='https://placehold.co/400x300/f2d7b4/d2691e?text=Image+Error';">
                            <h3 class="text-xl font-semibold mb-2 text-d2691e">${product.name}</h3>
                            <p class="text-gray-600 mb-3">${product.description}</p>
                            ${optionsHtml}
                            <div class="flex items-center space-x-2 mt-auto">
                                <button class="quantity-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300 transition-colors" data-product-id="${product.id}" data-action="decrease">-</button>
                                <input type="number" class="quantity-input w-16 text-center input-field rounded-lg" value="${initialQuantity}" min="0" data-product-id="${product.id}">
                                <button class="quantity-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300 transition-colors" data-product-id="${product.id}" data-action="increase">+</button>
                            </div>
                        `;
                        productsGrid.appendChild(productCard);
                    });
                    categorySection.appendChild(productsGrid);
                    productListDiv.appendChild(categorySection);
                }
            });

            // After rendering all products, attach event listeners and set up animations
            addQuantityEventListeners();
            addOptionChangeListeners();
            setupIntersectionObserver(); 
        }

        /**
         * Attaches event listeners to quantity increase/decrease buttons and input fields.
         */
        function addQuantityEventListeners() {
            document.querySelectorAll('.quantity-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productId = event.target.dataset.productId;
                    const action = event.target.dataset.action; // 'increase' or 'decrease'
                    const quantityInput = document.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                    let quantity = parseInt(quantityInput.value);

                    if (action === 'increase') {
                        quantity++;
                    } else if (action === 'decrease' && quantity > 0) {
                        quantity--;
                    }
                    quantityInput.value = quantity; // Update the input field
                    
                    // Get the currently selected option ID for this product
                    const selectedOptionElement = document.querySelector(`.product-option-select[data-product-id="${productId}"]`);
                    let optionId;
                    if (selectedOptionElement) {
                        optionId = selectedOptionElement.value;
                    } else {
                        // For products with only one option, use the default first optionId
                        optionId = productsFromFirestore.find(p => p.id === productId).options[0].optionId;
                    }
                    updateCart(productId, optionId, quantity); // Update the cart
                });
            });

            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', (event) => {
                    const productId = event.target.dataset.productId;
                    let quantity = parseInt(event.target.value);
                    // Ensure quantity is a non-negative number
                    if (isNaN(quantity) || quantity < 0) {
                        quantity = 0;
                        event.target.value = 0;
                    }
                    
                    // Get the currently selected option ID for this product
                    const selectedOptionElement = document.querySelector(`.product-option-select[data-product-id="${productId}"]`);
                    let optionId;
                    if (selectedOptionElement) {
                        optionId = selectedOptionElement.value;
                    } else {
                        // For products with only one option, use the default first optionId
                        optionId = productsFromFirestore.find(p => p.id === productId).options[0].optionId;
                    }
                    updateCart(productId, optionId, quantity); // Update the cart
                });
            });
        }

        /**
         * Attaches event listeners to product option select dropdowns.
         * When an option changes, it clears previous quantities for other options of the same product
         * and updates the cart with the new selection and its current quantity.
         */
        function addOptionChangeListeners() {
            document.querySelectorAll('.product-option-select').forEach(select => {
                select.addEventListener('change', (event) => {
                    const productId = event.target.dataset.productId;
                    const newOptionId = event.target.value;
                    const quantityInput = document.querySelector(`.quantity-input[data-product-id="${productId}"]`);

                    // Find the product to access its options
                    const product = productsFromFirestore.find(p => p.id === productId);
                    if (product) {
                        // Iterate through all options for this product
                        product.options.forEach(option => {
                            const key = `${productId}_${option.optionId}`;
                            // If an old option was in the cart and it's not the newly selected one, remove it
                            if (cart[key] && option.optionId !== newOptionId) {
                                delete cart[key];
                            }
                        });
                    }

                    // Update the cart with the new option and the quantity currently in the input field
                    const currentQuantity = parseInt(quantityInput.value);
                    updateCart(productId, newOptionId, currentQuantity);
                });
            });
        }


        /**
         * Updates the global `cart` object based on product, option, and quantity.
         * Renders the order summary after each update.
         * @param {string} productId - The ID of the product.
         * @param {string} optionId - The ID of the selected option (e.g., '250g', '1pc').
         * @param {number} quantity - The new quantity of the product for the given option.
         */
        function updateCart(productId, optionId, quantity) {
            const key = `${productId}_${optionId}`; // Unique key for product and its selected option
            if (quantity > 0) {
                cart[key] = quantity; // Add or update item in cart
            } else {
                delete cart[key]; // Remove item if quantity is zero
            }
            renderOrderSummary(); // Re-render the order summary to reflect changes
        }

        /**
         * Gets the price for a specific product option from the fetched products data.
         * @param {string} productId - The ID of the product.
         * @param {string} optionId - The ID of the selected option.
         * @returns {number} The price of the product option, or 0 if not found.
         */
        function getPrice(productId, optionId) {
            const product = productsFromFirestore.find(p => p.id === productId);
            if (product) {
                const option = product.options.find(o => o.optionId === optionId);
                if (option) {
                    return option.price;
                }
            }
            return 0; // Return 0 if product or option is not found (shouldn't happen with valid data)
        }

        /**
         * Renders the order summary section, displaying selected items and calculating the total.
         */
        function renderOrderSummary() {
            orderSummaryItemsDiv.innerHTML = ''; // Clear previous items in the summary
            let total = 0;
            let hasItemsInCart = false;

            // Iterate through items in the cart
            for (const key in cart) {
                const [productId, optionId] = key.split('_'); // Split key into product and option IDs
                const product = productsFromFirestore.find(p => p.id === productId); // Find product details

                if (product) {
                    hasItemsInCart = true;
                    const quantity = cart[key];
                    const option = product.options.find(o => o.optionId === optionId);

                    if (option) {
                        const itemTotal = option.price * quantity;
                        total += itemTotal;

                        // Create and append a summary item element
                        const summaryItem = document.createElement('div');
                        summaryItem.className = 'flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0';
                        summaryItem.innerHTML = `
                            <span>${product.name} (${option.label}) x ${quantity}</span>
                            <span>₹${itemTotal.toFixed(2)}</span>
                        `;
                        orderSummaryItemsDiv.appendChild(summaryItem);
                    }
                }
            }

            // Show/hide "Your cart is empty" message based on cart content
            if (hasItemsInCart) {
                emptyCartMessage.classList.add('hidden');
            } else {
                emptyCartMessage.classList.remove('hidden');
            }

            orderTotalSpan.textContent = `₹${total.toFixed(2)}`; // Update overall total display
        }

        /**
         * Handles the order form submission: validates cart, collects customer data,
         * saves the order to Firestore, and shows confirmation modal (with WhatsApp link).
         */
        async function handleOrderSubmission(event) {
            event.preventDefault(); // Prevent default browser form submission (page reload)

            // Check if the cart is empty
            if (Object.keys(cart).length === 0) {
                // Display a custom modal-like message if cart is empty
                const messageBox = document.createElement('div');
                messageBox.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                messageBox.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                        <p class="text-lg mb-4">Your cart is empty! Please add some items to place an order.</p>
                        <button class="btn-primary px-6 py-2 rounded-lg" onclick="this.parentNode.parentNode.remove()">OK</button>
                    </div>
                `;
                document.body.appendChild(messageBox);
                return; // Stop function execution
            }

            // Collect customer details from the form
            const customerName = orderForm.querySelector('#customerName').value;
            const customerPhone = orderForm.querySelector('#customerPhone').value;
            const customerEmail = orderForm.querySelector('#customerEmail').value;
            const specialInstructions = orderForm.querySelector('#specialInstructions').value;

            let orderedItems = []; // Array to store detailed order items for Firestore
            let total = 0;
            let orderDetailsText = `--- Yumm Healthy Bites Order ---\n\n`; // Text summary for the customer

            // Build the order details text and populate `orderedItems` array
            orderDetailsText += `Customer Name: ${customerName}\n`;
            orderDetailsText += `Phone Number: ${customerPhone}\n`;
            if (customerEmail) {
                orderDetailsText += `Email: ${customerEmail}\n`;
            }
            if (specialInstructions) {
                orderDetailsText += `Special Instructions: ${specialInstructions}\n`;
            }
            orderDetailsText += `\n--- Order Items ---\n`;

            for (const key in cart) {
                const [productId, optionId] = key.split('_');
                const product = productsFromFirestore.find(p => p.id === productId);
                if (product) {
                    const quantity = cart[key];
                    const option = product.options.find(o => o.optionId === optionId);
                    if (option) {
                        const itemTotal = option.price * quantity;
                        total += itemTotal;
                        orderedItems.push({
                            productId: productId,
                            productName: product.name,
                            optionId: optionId,
                            optionLabel: option.label,
                            pricePerUnit: option.price,
                            quantity: quantity,
                            itemTotal: itemTotal
                        });
                        orderDetailsText += `${product.name} (${option.label}) (x${quantity}) - ₹${itemTotal.toFixed(2)}\n`;
                    }
                }
            }
            orderDetailsText += `\nTotal Amount: ₹${total.toFixed(2)}\n\n`;
            orderDetailsText += `Payment will be collected during delivery.`; // Updated message


            // Prepare the order object to be saved in Firestore
            const newOrder = {
                customerName: customerName,
                customerPhone: customerPhone,
                customerEmail: customerEmail,
                specialInstructions: specialInstructions,
                items: orderedItems,
                totalAmount: total,
                orderDate: new Date(), // Capture current timestamp
                status: 'New' // Set initial order status
            };

            try {
                // Add the new order document to the 'orders' collection in Firestore
                const docRef = await addDoc(collection(db, "orders"), newOrder);
                console.log("Order written with ID: ", docRef.id);

                // Append the Firestore Order ID to the customer's summary text
                orderDetailsText += `\nYour Order ID: ${docRef.id}`; 

                // Display the complete order summary in the modal's textarea
                orderDetailsOutput.value = orderDetailsText;

                // Set the WhatsApp link
                // Encode the message to be URL-safe
                const whatsappMessage = encodeURIComponent(orderDetailsText);
                whatsappOrderBtn.href = `https://wa.me/${WHATSAPP_PHONE_NUMBER}?text=${whatsappMessage}`;

                // Show the order confirmation modal with animation
                orderModal.classList.remove('hidden');
                setTimeout(() => {
                    orderModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                    orderModal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
                }, 50); // Small delay to allow CSS transition to apply

                // Reset form and cart after successful order submission
                orderForm.reset();
                cart = {}; // Clear the cart
                fetchAndRenderProducts(); // Re-fetch and re-render products to reset quantities on the menu
                renderOrderSummary(); // Clear order summary display
            } catch (e) {
                console.error("Error adding document: ", e);
                // Display an error message if order submission fails
                const messageBox = document.createElement('div');
                messageBox.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                messageBox.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                        <p class="text-lg mb-4 text-red-600">There was an error placing your order. Please try again or contact us directly.</p>
                        <p class="text-sm text-gray-500">${e.message}</p>
                        <button class="btn-primary px-6 py-2 rounded-lg mt-4" onclick="this.parentNode.parentNode.remove()">OK</button>
                    </div>
                `;
                document.body.appendChild(messageBox);
            }
        }

        /**
         * Copies the order details output to the clipboard.
         */
        function copyOrderSummary() {
            orderDetailsOutput.select(); // Select the text in the textarea
            document.execCommand('copy'); // Execute copy command
            copyOrderBtn.textContent = 'Copied!'; // Provide feedback to user
            setTimeout(() => {
                copyOrderBtn.textContent = 'Copy Order Summary'; // Reset button text
            }, 2000);
        }

        /**
         * Closes the order confirmation modal with an animation.
         */
        function closeOrderModal() {
            orderModal.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100');
            orderModal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
            setTimeout(() => { // Hide modal completely after animation finishes
                orderModal.classList.add('hidden');
            }, 300);
        }


        /**
         * Sets up an Intersection Observer to apply a fade-in effect to product cards
         * as they become visible in the viewport.
         */
        function setupIntersectionObserver() {
            const productCards = document.querySelectorAll('.product-card'); // Get all product cards
            const observerOptions = {
                root: null, // Use the viewport as the root for observation
                rootMargin: '0px',
                threshold: 0.1 // Trigger when 10% of the element is visible
            };

            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible'); // Add class to trigger fade-in animation
                        observer.unobserve(entry.target); // Stop observing once the element is visible
                    }
                });
            }, observerOptions);

            // Observe each product card
            productCards.forEach(card => {
                observer.observe(card);
            });
        }

        /**
         * Sets up smooth scrolling for all internal navigation links (href="#section-id").
         */
        function setupSmoothScrolling() {
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault(); // Prevent default jump behavior
                    const targetId = this.getAttribute('href'); // Get the target section ID
                    const targetElement = document.querySelector(targetId); // Get the target element

                    if (targetElement) {
                        // Calculate scroll position, accounting for the sticky header's height and an additional offset
                        const headerOffset = navBar.offsetHeight + SCROLL_OFFSET; 
                        const elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
                        const offsetPosition = elementPosition - headerOffset;

                        // Perform smooth scroll
                        window.scrollTo({
                             top: offsetPosition,
                             behavior: "smooth"
                        });
                    }
                });
            });
        }

        /**
         * Initializes the application: fetches products, renders UI, and sets up event listeners.
         * This function is called once the window has fully loaded.
         */
        async function initApp() {
            await fetchAndRenderProducts(); // First, fetch products from Firestore and render them
            renderOrderSummary();         // Then, render the initial (empty) order summary
            setupSmoothScrolling();       // Finally, set up smooth scrolling for navigation

            // Attach event listeners for the order form and modal buttons
            orderForm.addEventListener('submit', handleOrderSubmission);
            copyOrderBtn.addEventListener('click', copyOrderSummary);
            closeModalBtn.addEventListener('click', closeOrderModal);
            topCloseModalBtn.addEventListener('click', closeOrderModal);
        }

        // --- Event Listeners & Initialization ---

        // Ensure the entire DOM is loaded before initializing the app
        window.onload = initApp;
    </script>
</body>
</html>
